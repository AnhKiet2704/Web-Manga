{% extends 'base.html' %}

{% block title %}{% if action == 'create' %}Th√™m chapter m·ªõi{% else %}S·ª≠a chapter{% endif %}{% endblock %}

{% block content %}
<div class="crud-form-container">
    <a href="{% url 'crud_chapter_list' manga.id %}" class="back-link">‚Üê Quay l·∫°i</a>
    <h1>{% if action == 'create' %}‚ûï Th√™m chapter m·ªõi{% else %}‚úèÔ∏è S·ª≠a chapter{% endif %}</h1>
    <h3>Truy·ªán: {{ manga.title }}</h3>

    <form method="post" enctype="multipart/form-data" class="crud-form">
        {% csrf_token %}

        <div class="form-row">
            <div class="form-group">
                <label for="chapter_number">S·ªë chapter <span class="required">*</span></label>
                <input type="number"
                       id="chapter_number"
                       name="chapter_number"
                       step="0.1"
                       value="{% if chapter %}{{ chapter.chapter_number }}{% endif %}"
                       required>
                <small>V√≠ d·ª•: 1, 1.5, 2...</small>
            </div>

            <div class="form-group">
                <label for="title">Ti√™u ƒë·ªÅ chapter (t√πy ch·ªçn)</label>
                <input type="text"
                       id="title"
                       name="title"
                       value="{% if chapter %}{{ chapter.title }}{% endif %}"
                       placeholder="V√≠ d·ª•: Kh·ªüi ƒë·∫ßu m·ªõi">
            </div>
        </div>

        {% if action == 'create' %}
        <div class="upload-section">
            <h3>üì§ Upload ·∫£nh chapter</h3>

            <div class="upload-methods">
                <div class="upload-method">
                    <h4>C√°ch 1: Upload t·ª´ng ·∫£nh</h4>
                    <input type="file"
                           name="images"
                           multiple
                           accept="image/*"
                           id="images">
                    <small>Ch·ªçn nhi·ªÅu ·∫£nh c√πng l√∫c (Ctrl + Click)</small>
                </div>

                <div class="upload-divider">HO·∫∂C</div>

                <div class="upload-method">
                    <h4>C√°ch 2: Upload file ZIP</h4>
                    <input type="file"
                           name="zip_file"
                           accept=".zip"
                           id="zip_file">
                    <small>File ZIP ch·ª©a t·∫•t c·∫£ ·∫£nh c·ªßa chapter. ·∫¢nh s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c s·∫Øp x·∫øp theo t√™n.</small>
                    <div class="zip-guide">
                        <p><strong>H∆∞·ªõng d·∫´n:</strong></p>
                        <ol>
                            <li>ƒê·∫∑t t√™n ·∫£nh theo th·ª© t·ª±: 001.jpg, 002.jpg, 003.jpg...</li>
                            <li>N√©n t·∫•t c·∫£ ·∫£nh v√†o 1 file .zip</li>
                            <li>Upload file zip</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if chapter %}
        <div class="current-images">
            <h3>·∫¢nh hi·ªán t·∫°i ({{ chapter.images.count }} trang)</h3>
            <div class="image-grid">
                {% for image in chapter.images.all %}
                <div class="image-item">
                    <img src="{{ image.image.url }}" alt="Page {{ image.page_number }}">
                    <p>Trang {{ image.page_number }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="form-actions">
            <button type="submit" class="btn btn-success">
                {% if action == 'create' %}‚ûï T·∫°o chapter{% else %}üíæ L∆∞u thay ƒë·ªïi{% endif %}
            </button>
            <a href="{% url 'crud_chapter_list' manga.id %}" class="btn btn-secondary">‚ùå H·ªßy</a>
        </div>
    </form>
</div>

<style>
.back-link {
    color: #007bff;
    display: inline-block;
    margin-bottom: 15px;
}

.upload-section {
    background: #f8f9fa;
    padding: 30px;
    border-radius: 8px;
    margin: 20px 0;
}

.upload-section h3 {
    margin-bottom: 20px;
}

.upload-methods {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 30px;
    align-items: center;
}

.upload-method {
    padding: 20px;
    background: white;
    border-radius: 8px;
    border: 2px dashed #ddd;
}

.upload-method h4 {
    margin-bottom: 15px;
    color: #007bff;
}

.upload-method input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 10px;
}

.upload-divider {
    background: #007bff;
    color: white;
    padding: 10px 15px;
    border-radius: 20px;
    font-weight: bold;
    text-align: center;
}

.zip-guide {
    margin-top: 15px;
    padding: 15px;
    background: #e7f3ff;
    border-left: 4px solid #007bff;
    border-radius: 5px;
}

.zip-guide p {
    margin-bottom: 10px;
    font-weight: 500;
}

.zip-guide ol {
    margin-left: 20px;
}

.zip-guide li {
    margin: 5px 0;
    color: #333;
}

.current-images {
    margin: 20px 0;
}

.current-images h3 {
    margin-bottom: 15px;
}

.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
}

.image-item {
    text-align: center;
}

.image-item img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.image-item p {
    margin-top: 5px;
    font-size: 12px;
    color: #666;
}

@media (max-width: 768px) {
    .upload-methods {
        grid-template-columns: 1fr;
    }

    .upload-divider {
        padding: 5px;
    }
}
</style>

<script>
// Prevent uploading both images and zip
document.getElementById('images').addEventListener('change', function() {
    if (this.files.length > 0) {
        document.getElementById('zip_file').value = '';
    }
});

document.getElementById('zip_file').addEventListener('change', function() {
    if (this.files.length > 0) {
        document.getElementById('images').value = '';
    }
});
</script>
{% endblock %}